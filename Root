<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily RPG â€” Tracker</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --text:#e7edf7; --muted:#9fb0c7; --line:#22304a;
      --tile0:#0a1220; --tile1:#12233a; --tile2:#1a395a; --tile3:#245b86; --tile4:#2f7cc0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .pill{border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:14px}
    @media (max-width:950px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .bar{height:12px;background:#0a1220;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .fill{height:100%;width:0%}
    .hp{background:linear-gradient(90deg,#ff4d6d,#ff9f1c)}
    .xp{background:linear-gradient(90deg,#2dd4bf,#60a5fa)}
    .muted{color:var(--muted)}
    .btn{background:#0a1220;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#36507a}
    .btn.danger{border-color:#7a3650}
    .btn.good{border-color:#2a7a60}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .toggle{display:flex;gap:10px;align-items:center}
    input[type="checkbox"]{transform:scale(1.15)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a1220}
    .item input{margin-top:3px}
    .tag{font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;color:var(--muted)}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a1220}
    .big{font-size:22px;font-weight:700}
    .log{max-height:220px;overflow:auto;margin-top:10px;border:1px solid var(--line);border-radius:12px;background:#0a1220;padding:10px}
    .log p{margin:0 0 8px 0;color:var(--muted);font-size:12px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    /* Calendar */
    .calHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .dow{font-size:11px;color:var(--muted);text-align:center}
    .dayCell{
      border:1px solid var(--line); border-radius:12px; padding:8px; min-height:70px;
      background:var(--tile0); position:relative; overflow:hidden;
    }
    .dayCell .n{font-size:11px;color:var(--muted)}
    .dayCell .v{font-size:12px;margin-top:6px}
    .dayCell .mini{font-size:10px;color:var(--muted);margin-top:3px}
    .dayCell.today{outline:2px solid #36507a}
    .dayCell.inactive{opacity:.35}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .sw{width:14px;height:14px;border-radius:4px;border:1px solid var(--line)}
    .sw0{background:var(--tile0)} .sw1{background:var(--tile1)} .sw2{background:var(--tile2)} .sw3{background:var(--tile3)} .sw4{background:var(--tile4)}

    /* Rewards */
    .rewardsGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .badge{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      border:1px solid var(--line);border-radius:12px;padding:10px;background:#0a1220
    }
    .badge .name{font-weight:600}
    .badge .desc{font-size:12px;color:var(--muted);margin-top:4px}
    .badge .state{font-size:11px;color:var(--muted)}
    .selectRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select{background:#0a1220;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Daily RPG â€” tu dÃ­a como juego</h1>
        <div class="hint">No es perfecciÃ³n. Es seguir jugando. Te muestra costo real y te premia por volver.</div>
      </div>
      <div class="row">
        <div class="pill" id="todayPill"></div>
        <button class="btn" id="resetBtn" title="Resetea solo el dÃ­a de hoy">Reset dÃ­a</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row">
          <div>
            <div class="muted">Personaje</div>
            <div class="big" id="levelText">Lv 1</div>
            <div class="hint" id="titleText"></div>
          </div>
          <div class="toggle">
            <label class="muted">Modo supervivencia</label>
            <input type="checkbox" id="survivalToggle" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div style="flex:1">
            <div class="row"><span>HP (energÃ­a)</span><span class="muted" id="hpText"></span></div>
            <div class="bar"><div class="fill hp" id="hpBar"></div></div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div style="flex:1">
            <div class="row"><span>XP (experiencia)</span><span class="muted" id="xpText"></span></div>
            <div class="bar"><div class="fill xp" id="xpBar"></div></div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div>
            <div class="muted">Objetivo del dÃ­a</div>
            <div id="goalText" class="hint"></div>
          </div>
          <div class="row">
            <button class="btn good" id="claimComebackBtn" title="Se activa si volviste despuÃ©s de un dÃ­a flojo">Reclamar comeback</button>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="muted">Streak</div>
            <div class="big" id="streakText">0</div>
          </div>
          <div class="box">
            <div class="muted">Quests hoy</div>
            <div class="big" id="doneText">0</div>
          </div>
          <div class="box">
            <div class="muted">Trampas hoy</div>
            <div class="big" id="badText">0</div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- Weekly missions -->
        <div class="row">
          <div>
            <div class="muted">Misiones semanales</div>
            <div class="hint" id="weeklyHint"></div>
          </div>
          <button class="btn good" id="claimWeeklyBtn">Claim semanal</button>
        </div>
        <div style="height:10px"></div>
        <div class="bar"><div class="fill xp" id="weeklyBar"></div></div>

        <div class="sep"></div>

        <!-- Log -->
        <div class="row">
          <div class="muted">Log (hoy)</div>
          <button class="btn danger" id="clearLogBtn">Borrar log</button>
        </div>
        <div class="log" id="logBox"></div>
      </section>

      <aside class="card">
        <!-- Quests -->
        <div class="row">
          <div class="muted">Quests (hÃ¡bitos que suman)</div>
          <button class="btn" id="uncheckGoodBtn">Desmarcar</button>
        </div>
        <div class="list" id="goodList"></div>

        <div class="sep"></div>

        <!-- Traps -->
        <div class="row">
          <div class="muted">Trampas (costos leves)</div>
          <button class="btn" id="uncheckBadBtn">Desmarcar</button>
        </div>
        <div class="list" id="badList"></div>

        <div class="sep"></div>

        <!-- Progress -->
        <div class="muted">Progreso</div>
        <div class="hint" id="progressText"></div>

        <div class="sep"></div>

        <!-- Calendar -->
        <div class="calHeader">
          <div>
            <div class="muted">Calendario + heatmap</div>
            <div class="hint">Intensidad = XP del dÃ­a. Click en un dÃ­a para ver resumen.</div>
          </div>
          <div class="row">
            <button class="btn" id="prevMonthBtn">â—€</button>
            <div class="pill" id="monthPill"></div>
            <button class="btn" id="nextMonthBtn">â–¶</button>
          </div>
        </div>

        <div class="calGrid" id="dowRow"></div>
        <div class="calGrid" id="calGrid"></div>

        <div class="legend">
          <span class="muted" style="font-size:11px">Menos</span>
          <span class="sw sw0"></span><span class="sw sw1"></span><span class="sw sw2"></span><span class="sw sw3"></span><span class="sw sw4"></span>
          <span class="muted" style="font-size:11px">MÃ¡s</span>
        </div>
        <div class="hint" id="dayDetail"></div>

        <div class="sep"></div>

        <!-- Rewards -->
        <div class="row">
          <div class="muted">Recompensas</div>
          <button class="btn" id="recalcRewardsBtn">Actualizar</button>
        </div>

        <div class="selectRow" style="margin-top:10px">
          <div class="hint">Skin:</div>
          <select id="skinSelect"></select>
          <div class="hint">TÃ­tulo:</div>
          <select id="titleSelect"></select>
        </div>

        <div class="rewardsGrid" id="achievementsList"></div>
      </aside>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const CONFIG = {
  baseHP: 100,
  xpToLevel: (level) => Math.round(80 + (level-1)*30),

  dailyGoal: { normalGood: 4, survivalGood: 2 },

  good: [
    { id:"sun",   name:"Luz solar al despertar (5â€“10 min)", xp:20, heal:5, tag:"salud" },
    { id:"move",  name:"Movimiento mÃ­nimo (10â€“20 min)", xp:25, heal:8, tag:"salud" },
    { id:"focus", name:"Bloque de foco (monotarea) 25â€“60 min", xp:30, heal:0, tag:"productividad", isFocus:true },
    { id:"plan",  name:"Plan del dÃ­a (3 prioridades)", xp:15, heal:0, tag:"productividad" },
    { id:"reflect", name:"ReflexiÃ³n 5 min (quÃ© aprendÃ­)", xp:15, heal:0, tag:"mente" },
    { id:"sleep", name:"Higiene de sueÃ±o (pantallas off 45 min antes)", xp:25, heal:10, tag:"salud" }
  ],

  bad: [
    { id:"doom",  name:"Doomscrolling > 20 min", hp:-8, xp:-5, tag:"costo real" },
    { id:"sugar", name:"AzÃºcar ultra-procesado por impulso", hp:-6, xp:-3, tag:"costo real" },
    { id:"late",  name:"Dormir < 6 h", hp:-12, xp:-8, tag:"costo real" },
    { id:"skip",  name:"SaltÃ© comidas + me desregulÃ©", hp:-7, xp:-4, tag:"costo real" },
    { id:"multi", name:"Multitarea caÃ³tica (sin foco)", hp:-5, xp:-6, tag:"costo real" },
    { id:"noSun", name:"Cero luz natural en el dÃ­a", hp:-6, xp:-2, tag:"costo real" }
  ],

  // Weekly missions
  weeklyMissions: [
    { id:"wk_focus8", name:"8 bloques de foco", desc:"Completar 8 'Bloque de foco' en la semana.", target:8, type:"focusBlocks", rewardXP:120, rewardHP:20 }
  ],

  // Rewards cosmetics
  skins: [
    { id:"default", name:"ClÃ¡sico" },
    { id:"night", name:"Night Runner" },
    { id:"steel", name:"Steel Mind" },
    { id:"sage", name:"Sage Mode" }
  ],

  titles: [
    { id:"rookie", name:"Rookie" , reqAch:"ach_first_day" },
    { id:"consistent", name:"Consistente", reqAch:"ach_7day_xp" },
    { id:"focus_master", name:"Maestra del foco", reqAch:"ach_focus20" },
    { id:"comeback", name:"Comeback Queen", reqAch:"ach_comeback3" }
  ],

  achievements: [
    { id:"ach_first_day", name:"Primera run", desc:"Registrar cualquier dÃ­a con al menos 1 quest.", check: (stats)=>stats.daysWithAnyQuest>=1 },
    { id:"ach_7day_xp", name:"Semana activa", desc:"Sumar 300 XP en los Ãºltimos 7 dÃ­as.", check: (stats)=>stats.weekXP>=300 },
    { id:"ach_month_xp", name:"Mes con tracciÃ³n", desc:"Sumar 1200 XP en el mes actual.", check: (stats)=>stats.monthXP>=1200 },
    { id:"ach_focus20", name:"Foco serio", desc:"Completar 20 bloques de foco totales.", check: (stats)=>stats.totalFocus>=20 },
    { id:"ach_streak5", name:"Streak 5", desc:"Alcanzar streak de 5 dÃ­as (cumpliendo objetivo).", check:(stats)=>stats.streak>=5 },
    { id:"ach_comeback3", name:"Volver es poder", desc:"Reclamar 3 come-backs.", check:(stats)=>stats.comebackCount>=3 }
  ]
};

/** =========================
 *  STATE
 *  ========================= */
const LS_KEY = "daily_rpg_v2";

function todayKey(d=new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseKey(k){
  const [y,m,d]=k.split("-").map(Number);
  return new Date(y, m-1, d);
}
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function save(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

function defaultState(){
  const t = todayKey();
  return {
    version: 2,
    profile: { level:1, totalXP:0, skin:"default", title:"rookie" },
    settings: { survival:false },
    rewards: { achievementsUnlocked:{}, weeklyClaims:{} },
    days: {
      [t]: { date:t, hp:CONFIG.baseHP, xpToday:0, goodDone:{}, badDone:{}, log:[], comebackClaimed:false }
    },
    meta: { lastActive:t, streak:0 }
  };
}

let state = load() || defaultState();

/** Ensure schema upgrades if user had v1 */
(function migrateIfNeeded(){
  if(!state.version || state.version < 2){
    // minimal migration: keep days/profile if exist
    const migrated = defaultState();
    migrated.days = state.days || migrated.days;
    migrated.profile.level = state.profile?.level || 1;
    migrated.profile.totalXP = state.profile?.totalXP || 0;
    migrated.settings.survival = state.settings?.survival || false;
    migrated.meta.lastActive = state.meta?.lastActive || todayKey();
    migrated.meta.streak = state.meta?.streak || 0;
    state = migrated;
    save(state);
  }
})();

function ensureToday(){
  const t = todayKey();
  if(!state.days[t]){
    state.days[t] = { date:t, hp:CONFIG.baseHP, xpToday:0, goodDone:{}, badDone:{}, log:[], comebackClaimed:false };
  }
  const last = state.meta.lastActive;
  if(last !== t){
    const y = new Date(); y.setDate(y.getDate()-1);
    const yk = todayKey(y);
    const yesterday = state.days[yk];
    const goal = dailyGoal();
    if(yesterday){
      const goodCount = Object.values(yesterday.goodDone||{}).filter(Boolean).length;
      state.meta.streak = (goodCount >= goal) ? (state.meta.streak||0)+1 : 0;
    } else state.meta.streak = 0;
    state.meta.lastActive = t;
  }
  save(state);
}
ensureToday();

function getDay(k=todayKey()){ return state.days[k]; }

/** =========================
 *  Helpers
 *  ========================= */
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
const $ = (id)=>document.getElementById(id);

function addLog(text){
  const d = getDay();
  d.log.unshift({ at: new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}), text });
  save(state);
}

function xpRequiredForNext(level){ return CONFIG.xpToLevel(level); }

function levelUpIfNeeded(){
  let { level, totalXP } = state.profile;
  while(totalXP >= xpRequiredForNext(level)){
    totalXP -= xpRequiredForNext(level);
    level += 1;
    addLog(`Subiste de nivel â†’ Lv ${level} ðŸŽ‰`);
  }
  state.profile.level = level;
  state.profile.totalXP = totalXP;
  save(state);
}

function dailyGoal(){
  return state.settings.survival ? CONFIG.dailyGoal.survivalGood : CONFIG.dailyGoal.normalGood;
}

/** =========================
 *  Game actions
 *  ========================= */
function applyGood(item, checked){
  const d = getDay();
  const was = !!d.goodDone[item.id];
  d.goodDone[item.id] = checked;

  if(!was && checked){
    d.xpToday += item.xp;
    state.profile.totalXP += item.xp;
    d.hp = clamp(d.hp + (item.heal||0), 0, CONFIG.baseHP);
    addLog(`+${item.xp} XP${item.heal?`, +${item.heal} HP`:``} â€” ${item.name}`);
  }
  if(was && !checked){
    d.xpToday -= item.xp;
    state.profile.totalXP = clamp(state.profile.totalXP - item.xp, 0, 999999999);
    d.hp = clamp(d.hp - (item.heal||0), 0, CONFIG.baseHP);
    addLog(`Undo â€” ${item.name}`);
  }

  save(state);
  levelUpIfNeeded();
  recalcRewards();
  render();
}

function applyBad(item, checked){
  const d = getDay();
  const was = !!d.badDone[item.id];
  d.badDone[item.id] = checked;

  if(!was && checked){
    d.hp = clamp(d.hp + item.hp, 0, CONFIG.baseHP);
    d.xpToday = clamp(d.xpToday + item.xp, -9999, 999999);
    state.profile.totalXP = clamp(state.profile.totalXP + item.xp, 0, 999999999);
    addLog(`${item.hp} HP, ${item.xp} XP â€” ${item.name}`);
  }
  if(was && !checked){
    d.hp = clamp(d.hp - item.hp, 0, CONFIG.baseHP);
    d.xpToday = clamp(d.xpToday - item.xp, -9999, 999999);
    state.profile.totalXP = clamp(state.profile.totalXP - item.xp, 0, 999999999);
    addLog(`Undo â€” ${item.name}`);
  }

  save(state);
  recalcRewards();
  render();
}

/** comeback */
function qualifiesComeback(){
  const y = new Date(); y.setDate(y.getDate()-1);
  const yk = todayKey(y);
  const yesterday = state.days[yk];
  const d = getDay();
  if(!yesterday) return false;
  const goal = dailyGoal();
  const goodY = Object.values(yesterday.goodDone||{}).filter(Boolean).length;
  const goodT = Object.values(d.goodDone||{}).filter(Boolean).length;
  return (goodY < goal) && (goodT >= 1) && !d.comebackClaimed;
}
function claimComeback(){
  const d = getDay();
  if(!qualifiesComeback()) return;
  const bonusXP = state.settings.survival ? 20 : 30;
  const bonusHP = 8;
  d.comebackClaimed = true;
  d.xpToday += bonusXP;
  state.profile.totalXP += bonusXP;
  d.hp = clamp(d.hp + bonusHP, 0, CONFIG.baseHP);
  addLog(`COMEBACK âœ… +${bonusXP} XP, +${bonusHP} HP â€” volviste al sistema`);
  save(state);
  levelUpIfNeeded();
  recalcRewards();
  render();
}

/** =========================
 *  Weekly missions
 *  ========================= */
function startOfWeek(date){
  // Monday-based week
  const d = new Date(date);
  const day = (d.getDay()+6)%7; // Mon=0..Sun=6
  d.setDate(d.getDate()-day);
  d.setHours(0,0,0,0);
  return d;
}
function weekId(date=new Date()){
  const s = startOfWeek(date);
  const y=s.getFullYear(), m=String(s.getMonth()+1).padStart(2,"0"), dd=String(s.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function keysForWeek(date=new Date()){
  const s = startOfWeek(date);
  const keys=[];
  for(let i=0;i<7;i++){
    const d=new Date(s); d.setDate(s.getDate()+i);
    keys.push(todayKey(d));
  }
  return keys;
}
function countFocusInWeek(date=new Date()){
  const keys = keysForWeek(date);
  let count=0;
  for(const k of keys){
    const day = state.days[k];
    if(!day) continue;
    if(day.goodDone?.focus) count += 1; // focus quest counts as one block
  }
  return count;
}
function weeklyMissionProgress(mission){
  if(mission.type==="focusBlocks"){
    return { current: countFocusInWeek(new Date()), target: mission.target };
  }
  return { current:0, target: mission.target };
}
function canClaimWeekly(mission){
  const id = weekId(new Date());
  const claimed = state.rewards.weeklyClaims?.[id]?.[mission.id];
  const prog = weeklyMissionProgress(mission);
  return !claimed && prog.current >= prog.target;
}
function claimWeekly(){
  const id = weekId(new Date());
  if(!state.rewards.weeklyClaims[id]) state.rewards.weeklyClaims[id]={};
  let claimedAny=false;

  for(const m of CONFIG.weeklyMissions){
    if(canClaimWeekly(m)){
      state.rewards.weeklyClaims[id][m.id] = true;
      const d = getDay();
      d.xpToday += m.rewardXP;
      state.profile.totalXP += m.rewardXP;
      d.hp = clamp(d.hp + m.rewardHP, 0, CONFIG.baseHP);
      addLog(`MisiÃ³n semanal âœ… ${m.name} â†’ +${m.rewardXP} XP, +${m.rewardHP} HP`);
      claimedAny=true;
    }
  }
  if(claimedAny){
    save(state);
    levelUpIfNeeded();
    recalcRewards();
    render();
  }
}

/** =========================
 *  Progress summaries
 *  ========================= */
function rangeKeys(daysBack){
  const keys = [];
  const now = new Date();
  for(let i=0;i<daysBack;i++){
    const d = new Date(now); d.setDate(now.getDate()-i);
    keys.push(todayKey(d));
  }
  return keys;
}
function monthKeys(ref=new Date()){
  const y = ref.getFullYear(), m = ref.getMonth();
  const first = new Date(y,m,1);
  const keys=[];
  for(let d=new Date(first); d.getMonth()===m; d.setDate(d.getDate()+1)) keys.push(todayKey(d));
  return keys;
}
function summarize(keys){
  let xp=0, good=0, bad=0, days=0;
  for(const k of keys){
    const d = state.days[k];
    if(!d) continue;
    days++;
    xp += (d.xpToday||0);
    good += Object.values(d.goodDone||{}).filter(Boolean).length;
    bad += Object.values(d.badDone||{}).filter(Boolean).length;
  }
  return { xp, good, bad, days };
}

/** =========================
 *  Rewards / Achievements
 *  ========================= */
function computeStatsForRewards(){
  const week = summarize(rangeKeys(7));
  const month = summarize(monthKeys(new Date()));
  let totalFocus=0;
  let daysWithAnyQuest=0;
  let comebackCount=0;

  for(const k of Object.keys(state.days)){
    const d = state.days[k];
    const goodCount = Object.values(d.goodDone||{}).filter(Boolean).length;
    if(goodCount>=1) daysWithAnyQuest++;
    if(d.goodDone?.focus) totalFocus++;
    if(d.comebackClaimed) comebackCount++;
  }
  return {
    weekXP: week.xp,
    monthXP: month.xp,
    totalFocus,
    daysWithAnyQuest,
    streak: state.meta.streak||0,
    comebackCount
  };
}

function recalcRewards(){
  const stats = computeStatsForRewards();
  const unlocked = state.rewards.achievementsUnlocked || {};
  let changed=false;

  for(const ach of CONFIG.achievements){
    if(!unlocked[ach.id] && ach.check(stats)){
      unlocked[ach.id] = { at: todayKey(), name: ach.name };
      addLog(`LOGRO ðŸ… ${ach.name} â€” ${ach.desc}`);
      changed=true;
    }
  }
  state.rewards.achievementsUnlocked = unlocked;

  // ensure current title/skin are valid (requirement met)
  const titleOk = CONFIG.titles.find(t=>t.id===state.profile.title && unlocked[t.reqAch]);
  if(!titleOk){
    // pick first available
    const firstAvail = CONFIG.titles.find(t=>unlocked[t.reqAch]) || CONFIG.titles[0];
    state.profile.title = firstAvail.id;
    changed=true;
  }

  // skins: let user pick any unlocked via simple mapping (achievements unlock skins)
  // simple rule: each achievement unlocks a skin in order
  // (kept simple; you can map manually)
  save(state);
  if(changed) save(state);
}

/** Available cosmetics */
function availableTitles(){
  const unlocked = state.rewards.achievementsUnlocked || {};
  return CONFIG.titles.filter(t=>unlocked[t.reqAch] || t.id==="rookie");
}
function availableSkins(){
  const unlockedCount = Object.keys(state.rewards.achievementsUnlocked||{}).length;
  // unlock 1 skin every 2 achievements (so it feels earned)
  const max = 1 + Math.floor(unlockedCount/2);
  return CONFIG.skins.slice(0, clamp(max,1,CONFIG.skins.length));
}

/** =========================
 *  Calendar / Heatmap
 *  ========================= */
let calRef = new Date(); // month being shown

function monthLabel(d){
  return d.toLocaleDateString("es-AR",{month:"long", year:"numeric"});
}
function heatLevelForXP(xp){
  // Map xp -> 0..4
  if(!xp || xp <= 0) return 0;
  if(xp < 40) return 1;
  if(xp < 80) return 2;
  if(xp < 140) return 3;
  return 4;
}
function heatColor(level){
  return ["var(--tile0)","var(--tile1)","var(--tile2)","var(--tile3)","var(--tile4)"][level];
}
function renderCalendar(){
  $("monthPill").textContent = monthLabel(calRef);

  const dowNames = ["L","M","X","J","V","S","D"];
  const dowRow = $("dowRow");
  dowRow.innerHTML = "";
  for(const n of dowNames){
    const el=document.createElement("div");
    el.className="dow";
    el.textContent=n;
    dowRow.appendChild(el);
  }

  const grid = $("calGrid");
  grid.innerHTML="";

  const y=calRef.getFullYear(), m=calRef.getMonth();
  const first = new Date(y,m,1);
  const last = new Date(y,m+1,0);
  const firstDow = (first.getDay()+6)%7; // monday-based 0..6
  const daysInMonth = last.getDate();

  // cells: leading blanks
  const totalCells = Math.ceil((firstDow + daysInMonth)/7)*7;

  const today = todayKey();

  for(let i=0;i<totalCells;i++){
    const cell=document.createElement("div");
    cell.className="dayCell";
    const dayNum = i - firstDow + 1;

    if(dayNum < 1 || dayNum > daysInMonth){
      cell.classList.add("inactive");
      cell.innerHTML = `<div class="n"> </div>`;
      grid.appendChild(cell);
      continue;
    }

    const dateObj = new Date(y,m,dayNum);
    const key = todayKey(dateObj);
    const d = state.days[key];
    const xp = d?.xpToday || 0;
    const good = d ? Object.values(d.goodDone||{}).filter(Boolean).length : 0;
    const bad = d ? Object.values(d.badDone||{}).filter(Boolean).length : 0;

    const lvl = heatLevelForXP(xp);
    cell.style.background = heatColor(lvl);

    if(key===today) cell.classList.add("today");

    cell.innerHTML = `
      <div class="n">${dayNum}</div>
      <div class="v">${xp} XP</div>
      <div class="mini">${good}Q â€¢ ${bad}T</div>
    `;
    cell.addEventListener("click", ()=>{
      const desc = d
        ? `ðŸ“… ${key}: ${xp} XP â€¢ HP ${d.hp}/${CONFIG.baseHP} â€¢ Quests ${good} â€¢ Trampas ${bad}`
        : `ðŸ“… ${key}: sin registro.`;
      $("dayDetail").textContent = desc;
    });

    grid.appendChild(cell);
  }
}

/** =========================
 *  Render lists / UI
 *  ========================= */
function renderLists(){
  const goodList = $("goodList");
  const badList = $("badList");
  goodList.innerHTML="";
  badList.innerHTML="";

  const d = getDay();

  for(const item of CONFIG.good){
    const wrap=document.createElement("div");
    wrap.className="item";
    wrap.innerHTML = `
      <input type="checkbox" ${d.goodDone[item.id] ? "checked":""} />
      <div>
        <div>${item.name}</div>
        <div class="muted">+${item.xp} XP ${item.heal?`â€¢ +${item.heal} HP`:``}</div>
      </div>
      <div class="right"><span class="tag">${item.tag}</span></div>
    `;
    wrap.querySelector("input").addEventListener("change",(e)=>applyGood(item,e.target.checked));
    goodList.appendChild(wrap);
  }

  for(const item of CONFIG.bad){
    const wrap=document.createElement("div");
    wrap.className="item";
    wrap.innerHTML = `
      <input type="checkbox" ${d.badDone[item.id] ? "checked":""} />
      <div>
        <div>${item.name}</div>
        <div class="muted">${item.hp} HP â€¢ ${item.xp} XP</div>
      </div>
      <div class="right"><span class="tag">${item.tag}</span></div>
    `;
    wrap.querySelector("input").addEventListener("change",(e)=>applyBad(item,e.target.checked));
    badList.appendChild(wrap);
  }
}

function renderRewards(){
  // cosmetics selects
  const skinSelect = $("skinSelect");
  const titleSelect = $("titleSelect");
  const availSkins = availableSkins();
  const availTitles = availableTitles();

  skinSelect.innerHTML = "";
  for(const s of availSkins){
    const opt=document.createElement("option");
    opt.value=s.id; opt.textContent=s.name;
    if(state.profile.skin===s.id) opt.selected=true;
    skinSelect.appendChild(opt);
  }
  titleSelect.innerHTML = "";
  for(const t of availTitles){
    const opt=document.createElement("option");
    opt.value=t.id; opt.textContent=t.name;
    if(state.profile.title===t.id) opt.selected=true;
    titleSelect.appendChild(opt);
  }

  // show current title text
  const currentTitle = CONFIG.titles.find(t=>t.id===state.profile.title)?.name || "Rookie";
  $("titleText").textContent = `TÃ­tulo: ${currentTitle} â€¢ Skin: ${CONFIG.skins.find(s=>s.id===state.profile.skin)?.name||"ClÃ¡sico"}`;

  // achievements list
  const unlocked = state.rewards.achievementsUnlocked || {};
  const list = $("achievementsList");
  list.innerHTML="";
  for(const ach of CONFIG.achievements){
    const isOn = !!unlocked[ach.id];
    const b=document.createElement("div");
    b.className="badge";
    b.innerHTML = `
      <div>
        <div class="name">${isOn ? "âœ…" : "â¬œ"} ${ach.name}</div>
        <div class="desc">${ach.desc}</div>
      </div>
      <div class="state">${isOn ? `Desbloqueado (${unlocked[ach.id].at})` : "Bloqueado"}</div>
    `;
    list.appendChild(b);
  }
}

function renderWeekly(){
  const m = CONFIG.weeklyMissions[0];
  const prog = weeklyMissionProgress(m);
  const pct = clamp((prog.current/prog.target)*100,0,100);
  $("weeklyBar").style.width = `${pct}%`;
  $("weeklyHint").textContent = `${m.name}: ${prog.current}/${prog.target} â€” recompensa: +${m.rewardXP} XP, +${m.rewardHP} HP. Semana: ${weekId(new Date())}`;
  $("claimWeeklyBtn").disabled = !canClaimWeekly(m);
}

function render(){
  const d = getDay();
  const t = todayKey();
  $("todayPill").textContent = `Hoy: ${t}`;
  $("survivalToggle").checked = !!state.settings.survival;

  const hp = clamp(d.hp,0,CONFIG.baseHP);
  $("hpText").textContent = `${hp}/${CONFIG.baseHP}`;
  $("hpBar").style.width = `${(hp/CONFIG.baseHP)*100}%`;

  const lvl = state.profile.level;
  const req = xpRequiredForNext(lvl);
  const bank = clamp(state.profile.totalXP,0,req);
  $("levelText").textContent = `Lv ${lvl}`;
  $("xpText").textContent = `${bank}/${req} (hoy: ${d.xpToday})`;
  $("xpBar").style.width = `${(bank/req)*100}%`;

  const goodCount = Object.values(d.goodDone||{}).filter(Boolean).length;
  const badCount  = Object.values(d.badDone||{}).filter(Boolean).length;
  $("doneText").textContent = goodCount;
  $("badText").textContent  = badCount;
  $("streakText").textContent = state.meta.streak || 0;

  const goal = dailyGoal();
  const mode = state.settings.survival ? "Supervivencia" : "Normal";
  $("goalText").textContent = `${mode}: objetivo = ${goal} quests. Si hoy hacÃ©s 1, ya estÃ¡s jugando.`;

  $("claimComebackBtn").disabled = !qualifiesComeback();

  // log
  const logBox = $("logBox");
  logBox.innerHTML="";
  if(!d.log.length) logBox.innerHTML = `<p>Sin eventos aÃºn. MarcÃ¡ una quest y arrancÃ¡s.</p>`;
  else for(const e of d.log){
    const p=document.createElement("p");
    p.textContent = `[${e.at}] ${e.text}`;
    logBox.appendChild(p);
  }

  const week = summarize(rangeKeys(7));
  const month = summarize(monthKeys(new Date()));
  $("progressText").innerHTML =
    `Ãšltimos 7 dÃ­as: <b>${week.xp}</b> XP, <b>${week.good}</b> quests, <b>${week.bad}</b> trampas (dÃ­as: ${week.days}).<br/>
     Mes actual: <b>${month.xp}</b> XP, <b>${month.good}</b> quests, <b>${month.bad}</b> trampas (dÃ­as: ${month.days}).`;

  renderLists();
  renderWeekly();
  renderCalendar();
  renderRewards();
}

/** =========================
 *  UI events
 *  ========================= */
$("survivalToggle").addEventListener("change",(e)=>{
  state.settings.survival = e.target.checked;
  addLog(state.settings.survival ? "Modo supervivencia ON â€” hoy vale el mÃ­nimo." : "Modo supervivencia OFF â€” volvÃ©s a normal.");
  save(state);
  render();
});

$("claimComebackBtn").addEventListener("click", claimComeback);
$("claimWeeklyBtn").addEventListener("click", claimWeekly);

$("resetBtn").addEventListener("click", ()=>{
  const t = todayKey();
  state.days[t] = { date:t, hp:CONFIG.baseHP, xpToday:0, goodDone:{}, badDone:{}, log:[], comebackClaimed:false };
  addLog("DÃ­a reseteado (solo hoy).");
  save(state);
  recalcRewards();
  render();
});

$("clearLogBtn").addEventListener("click", ()=>{
  getDay().log=[];
  save(state);
  render();
});

$("uncheckGoodBtn").addEventListener("click", ()=>{
  const d=getDay();
  for(const k of Object.keys(d.goodDone||{})) d.goodDone[k]=false;
  save(state);
  render();
});
$("uncheckBadBtn").addEventListener("click", ()=>{
  const d=getDay();
  for(const k of Object.keys(d.badDone||{})) d.badDone[k]=false;
  save(state);
  render();
});

$("prevMonthBtn").addEventListener("click", ()=>{
  calRef = new Date(calRef.getFullYear(), calRef.getMonth()-1, 1);
  renderCalendar();
});
$("nextMonthBtn").addEventListener("click", ()=>{
  calRef = new Date(calRef.getFullYear(), calRef.getMonth()+1, 1);
  renderCalendar();
});

$("recalcRewardsBtn").addEventListener("click", ()=>{
  recalcRewards();
  renderRewards();
});

$("skinSelect").addEventListener("change",(e)=>{
  state.profile.skin = e.target.value;
  save(state);
  renderRewards();
});
$("titleSelect").addEventListener("change",(e)=>{
  state.profile.title = e.target.value;
  save(state);
  renderRewards();
});

/** Init */
recalcRewards();
render();
</script>
</body>
</html>
